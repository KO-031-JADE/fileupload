<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload</title>

    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css' />
    <link rel='stylesheet' href='./css/style.css' />
</head>

<body class="m-4">
    <form id="upload-form" class="mb-4">
        <input type="text" name="title" class="form-control mb-2" placeholder="Title" required />
        <textarea name="description" class="form-control mb-2" placeholder="Description" required></textarea>
        <div class="dropzone"></div>
        <button type="button" id="submit-button" class="btn btn-primary mt-3">Submit</button>
    </form>

    <ul class="list-unstyled mb-0" id="dropzone-preview">
        <li class="mt-2" id="dropzone-preview-list">
            <div class="border rounded-3">
                <div class="d-flex align-items-center p-2">
                    <div class="flex-shrink-0 me-3">
                        <div class="width-8 h-auto rounded-3">
                            <img data-dz-thumbnail class="w-full h-auto rounded-3 block" src="#" alt="Dropzone-Image" style="width: 120px;" />
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="pt-1">
                            <h6 class="font-semibold mb-1" data-dz-name>&nbsp;</h6>
                            <p class="text-sm text-muted fw-normal" data-dz-size></p>
                            <strong class="error text-danger" data-dz-errormessage></strong>
                        </div>
                    </div>
                    <div class="shrink-0">
                        <button data-dz-remove class="btn btn-sm btn-danger">X</button>
                    </div>
                </div>
            </div>
        </li>
    </ul>

    <script>
        Dropzone.autoDiscover = false;
        var dropzonePreviewNode = document.querySelector('#dropzone-preview-list');
        dropzonePreviewNode.id = '';
        var previewTemplate = dropzonePreviewNode.parentNode.innerHTML;
        dropzonePreviewNode.parentNode.removeChild(dropzonePreviewNode);

        const dropzone = new Dropzone(".dropzone", {
            url: "https://httpbin.org/post",
            method: "post",
            autoProcessQueue: false,
            previewTemplate: previewTemplate,
            previewsContainer: '#dropzone-preview',
            acceptedFiles: "image/jpeg,image/png,image/gif,image/jpg",
            maxFiles: 3,
            init: function () {
                var myDropzone = this;

                // 파일이 추가되었을 때
                this.on("addedfile", function (file) {
                    const fileName = file.name;
                    const fileExtension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();
                    console.log("File Extension: " + fileExtension);

                    if (!['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                        console.log("이미지 파일 확인부탁드립니다.");
                        this.removeFile(file);
                    }
                });

                // 최대 파일 개수 초과 시
                this.on("maxfilesexceeded", function (file) {
                    alert("최대 3개 이미지 업로드가 가능합니다.");
                    this.removeFile(file);
                });

                // 전송 버튼 클릭 시 처리
                document.getElementById("submit-button").addEventListener("click", function () {
                    if (myDropzone.getQueuedFiles().length > 0) {
                        myDropzone.processQueue();
                    } else {
                        alert("최소 1개의 이미지를 업로드해주세요.");
                    }
                }, { once: true }); // { once: true }로 한 번만 실행되도록 설정

                // 파일이 전송되기 전 추가 데이터를 폼에서 가져와 추가
                this.on("sending", function (file, xhr, formData) {
                    formData.append("title", document.querySelector("input[name='title']").value);
                    formData.append("description", document.querySelector("textarea[name='description']").value);

                    // 현재 이미지 순서를 가져와 formData에 추가
                    const uploadedFiles = document.querySelectorAll('#dropzone-preview .dz-image-preview');
                    const fileOrder = Array.from(uploadedFiles).map((item) => {
                        return item.querySelector('[data-dz-name]').textContent.trim();
                    });

                    // 콘솔에 이미지 제목 순서대로 출력
                    console.log("Image titles in order:", fileOrder);
                });

                // 파일이 성공적으로 업로드된 경우
                this.on("successmultiple", function (files, response) {
                    console.log("Files successfully uploaded!", response);
                    alert("파일이 성공적으로 업로드되었습니다!");
                });
            }
        });

        // Sortable 적용
        const sortable = new Sortable(document.getElementById('dropzone-preview'), {
            animation: 150,
            ghostClass: 'sortable-ghost',
            handle: '.border',
            onEnd: function (/**Event*/evt) {
                // 드래그가 끝난 후 변경된 순서 출력
                const uploadedFiles = document.querySelectorAll('#dropzone-preview .dz-image-preview');
                const fileOrder = Array.from(uploadedFiles).map((item) => {
                    return item.querySelector('[data-dz-name]').textContent.trim();
                });
                console.log("Updated image order:", fileOrder);
            }
        });
    </script>
</body>

</html>
